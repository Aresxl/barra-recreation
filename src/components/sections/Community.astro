---
import CustomPicture from "../ui/CustomPicture.astro";
import Heading from "../ui/Heading.astro";
import LinkOrButton from "../ui/LinkOrButton.astro";

// Images
import CommunityHeaderImg from "@/assets/images/mobile/community-header-2x.jpg";

import AlejandroHeadshotMobile from "@/assets/images/mobile/chef-alejandro.jpg";
import AlejandroHeadshotDesktop from "@/assets/images/mobile/chef-alejandro.jpg";

import CarouselSlideMobileImg1 from "@/assets/images/mobile/barra-night-2x.jpg";
import CarouselSlideMobileImg2 from "@/assets/images/mobile/table-image-2-2x.jpg";
import CarouselSlideMobileImg3 from "@/assets/images/mobile/lamp-2x.jpg";

import CarouselSlideDesktopImg1 from "@/assets/images/desktop/barra-night-1x.jpg";
import CarouselSlideDesktopImg2 from "@/assets/images/desktop/table-image-2-1x.jpg";
import CarouselSlideDesktopImg3 from "@/assets/images/desktop/lamp-2x.jpg";
---

<section class="community | grid-main">
  <header class="community__header">
    <div class="community__header-content">
      <Heading tag="h2" size="h2" title="Community, Culture & Discovery" />
      <p class="community__header-desc">
        More than just a Latin Restaurant, Barra channels the lively spirit of a neighbourhood
        cantina - casual, welcoming and full of energy. Here, you'll find shareable small plates
        inspired by traditional dishes across Latin America, bold cocktails and a curated wine list
        celebrating Latin varietals alongside local favourites.
      </p>
      <LinkOrButton as="a" href="/booking" variant="outline" color="black" text="Book a table" />
    </div>
    <CustomPicture
      desktop={CommunityHeaderImg}
      mobile={CommunityHeaderImg}
      fallbackWidth={CommunityHeaderImg.width}
      fallbackHeight={CommunityHeaderImg.height}
      priority={false}
      alt=""
      class="community__header-picture"
    />
  </header>
  <figure>
    <div class="figure__picture-wrapper">
      <CustomPicture
        desktop={AlejandroHeadshotDesktop}
        mobile={AlejandroHeadshotMobile}
        fallbackWidth={AlejandroHeadshotMobile.width}
        fallbackHeight={AlejandroHeadshotMobile.height}
        priority={false}
        alt=""
        class="figure__picture"
      />
    </div>
    <figcaption>
      <blockquote>
        "At its core, Barra is about community, culture and discovery - bringing Melbourne together
        over food, wine and stories from across the Latin world."
      </blockquote>
      <cite>Executive Chef Alejandro Saravia</cite>
    </figcaption>
  </figure>
  <div class="carousel community__carousel">
    <div class="carousel__button-wrapper">
      <button class="carousel__btn prev" data-carousel-btn="prev" aria-label="Previous slide"
        >&lt;</button
      >
      <button class="carousel__btn next" data-carousel-btn="next" aria-label="Next slide"
        >&gt;</button
      >
    </div>
    <div class="carousel__indicators">
      <button class="carousel__indicator" aria-label="Slide 1" data-indicator-active></button>
      <button class="carousel__indicator" aria-label="Slide 2"></button>
      <button class="carousel__indicator" aria-label="Slide 3"></button>
    </div>
    <CustomPicture
      desktop={CarouselSlideDesktopImg1}
      mobile={CarouselSlideMobileImg1}
      fallbackWidth={CarouselSlideMobileImg1.width}
      fallbackHeight={CarouselSlideMobileImg1.height}
      priority={false}
      alt=""
      class="slide slide--1"
      data-active
    />
    <CustomPicture
      desktop={CarouselSlideDesktopImg2}
      mobile={CarouselSlideMobileImg2}
      fallbackWidth={CarouselSlideMobileImg2.width}
      fallbackHeight={CarouselSlideMobileImg2.height}
      priority={false}
      alt=""
      class="slide slide--2"
    />
    <CustomPicture
      desktop={CarouselSlideDesktopImg3}
      tablet={CarouselSlideDesktopImg3}
      mobile={CarouselSlideMobileImg3}
      fallbackWidth={CarouselSlideMobileImg3.width}
      fallbackHeight={CarouselSlideMobileImg3.height}
      priority={false}
      alt=""
      class="slide slide--3"
    />
  </div>
</section>

<style>
  .community {
    margin-block: 40px 60px;
  }

  .community__header-content {
    display: grid;
    gap: 20px;
    margin-block-end: 60px;

    .btn {
      justify-self: start;
    }
  }

  figure {
    margin-block: 60px 30px;
  }

  figcaption {
    position: relative;
    margin-block-start: 20px;
    padding-inline-start: 20px;
    font-size: var(--fs-250);
    font-family: var(--ff-secondary);

    &::before {
      content: "";
      display: block;
      position: absolute;
      left: 0;
      background-color: var(--clr-primary-gold-400);
      width: 2px;
      height: 100%;
    }
  }

  cite {
    display: block;
    margin-block-start: 10px;
    font-size: var(--fs-400);
    font-family: var(--ff-main);
    font-style: normal;
  }

  .carousel {
    position: relative;

    .slide {
      position: absolute;
      inset: 0;
      visibility: hidden;
      opacity: 0;
      transition: 150ms ease-in-out;
      transition-property: opacity, visibility;

      img {
        border-radius: 15px;
        object-fit: cover;
        height: 350px;
      }
    }

    [data-active] {
      position: relative;
      opacity: 1;
      visibility: visible;
    }

    .carousel__btn {
      position: absolute;
      z-index: 10;
      top: 50%;
      transform: translateY(-50%);
      border: none;
      background: none;
      color: var(--clr-neutral-100);
      font-size: 40px;
      cursor: pointer;
    }

    .carousel__btn.prev {
      left: 2px;
    }

    .carousel__btn.next {
      right: 2px;
    }
  }

  .carousel__indicators {
    position: absolute;
    top: 100%;
    right: 50%;
    transform: translateX(50%);
    display: flex;
    gap: 16px;
    padding-block-start: 15px;

    .carousel__indicator {
      width: 10px;
      height: 10px;
      border: none;
      border-radius: 100%;
      background-color: #ccc;
      cursor: pointer;
    }
  }

  .carousel__indicator[data-indicator-active] {
    background-color: black;
  }

  @media (min-width: 46rem) {
    .community {
      margin-block: 40px;
    }

    .community__header {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 60px;
    }

    .community__header-content {
      margin-block-end: 0px;
    }

    figure {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
    }

    figcaption {
      align-self: center;
      margin-block-start: 0px;
      padding-inline-start: 25px;
    }

    /* Carousel Shit */

    .carousel__button-wrapper,
    .carousel__indicators {
      display: none;
    }

    .carousel {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;

      .slide {
        position: relative;
        opacity: 1;
        visibility: unset;

        img {
          min-height: 465px;
          border-radius: 30px;
        }
      }

      .slide--3 {
        grid-column: 1 / -1;

        img {
          width: 100%;
          object-fit: cover;
        }
      }
    }
  }

  @media (min-width: 62.5rem) {
    .community {
      margin-block-start: 60px;
    }

    .community__header-content {
      align-content: center;
    }

    figure {
      margin-block: 100px 80px;
    }
  }
</style>

<script>
  const carousel = document.querySelector(`.community__carousel`);
  const carouselBtns = carousel?.querySelectorAll<HTMLButtonElement>(`.carousel__btn`);
  const carouselIndicatorBtns =
    carousel?.querySelectorAll<HTMLButtonElement>(`.carousel__indicator`);

  function goToSlide(newIndex: any) {
    const slides = carousel!.querySelectorAll<HTMLElement>(`.slide`);
    const indicators = carousel!.querySelectorAll<HTMLButtonElement>(`.carousel__indicator`);

    const currentSlide = carousel?.querySelector<HTMLElement>(`.slide[data-active]`);
    const currentIndicator = carousel?.querySelector<HTMLElement>(
      `.carousel__indicator[data-indicator-active]`,
    );
    console.log(currentIndicator);

    if (currentSlide) delete currentSlide.dataset.active;
    if (currentIndicator) delete currentIndicator.dataset.indicatorActive;

    const targetIndex = (newIndex + slides.length) % slides.length;

    slides[targetIndex].dataset.active = `true`;
    indicators[targetIndex].dataset.indicatorActive = `true`;
  }

  carouselBtns!.forEach((btn) => {
    btn.addEventListener(`click`, (e) => {
      const activeSlide = carousel!.querySelector<HTMLElement>(`.slide[data-active]`);

      if (!activeSlide) return;

      const slides = carousel!.querySelectorAll<HTMLElement>(`.slide`);
      const currentIndex = [...slides].indexOf(activeSlide);

      const offset = btn.dataset.carouselBtn === "next" ? 1 : -1;
      goToSlide(currentIndex + offset);
    });
  });

  carouselIndicatorBtns?.forEach((btn, i) => {
    btn.addEventListener(`click`, () => {
      goToSlide(i);
    });
  });
</script>
